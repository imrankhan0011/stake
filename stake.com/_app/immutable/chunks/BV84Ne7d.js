var M=Object.defineProperty;var T=(t,r,e)=>r in t?M(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e;var c=(t,r,e)=>T(t,typeof r!="symbol"?r+"":r,e);import{b as m,d as D}from"./BS6f7dTc.js";import{p as x}from"./DV_bOSsD.js";const A=1e4,R={"Content-Type":"application/json","Access-Control-Allow-Origin":"*"};function L(t,r={}){const e=new Headers;if(t.headers instanceof Headers)for(const[n,o]of t.headers.entries())e.set(n,o);for(const[n,o]of Object.entries(r))e.set(n,o);return e}function I(t={}){return({request:r})=>{const e=L(r,t);return{...r,headers:e}}}function F({request:t,session:r}){const e={};r!=null&&r.session&&(e["x-access-token"]=r.session),r!=null&&r.locale&&(e["x-language"]=r.locale);const n=L(t,e);return{...t,headers:n}}function N({request:t,doc:r}){var g,E;const e=(g=r==null?void 0:r.definitions)==null?void 0:g[0],o={"x-operation-name":("name"in e?(E=e.name)==null?void 0:E.value:void 0)||"unknown","x-operation-type":"query"},a=L(t,o);return{...t,headers:a}}class b{constructor(r){c(this,"url");c(this,"logger");c(this,"defaultHeaders");c(this,"requestInterceptors");c(this,"graphQLErrorInterceptors");c(this,"networkErrorInterceptors");c(this,"cacheMap");this.url=r.url,this.logger=r.logger||console,this.defaultHeaders={...r.defaultHeaders||R},this.cacheMap=new Map,this.requestInterceptors=[I(this.defaultHeaders),N,...r.requestInterceptors||[]],this.graphQLErrorInterceptors=r.graphQLErrorInterceptors||[],this.networkErrorInterceptors=r.networkErrorInterceptors||[]}async query(r){var k,Q;const{doc:e,variables:n,cache:o,logger:a=this.logger,requestInterceptors:g=this.requestInterceptors,graphQLErrorInterceptors:E=this.graphQLErrorInterceptors,networkErrorInterceptors:S=this.networkErrorInterceptors}=r;let h=r.load;const q=(k=e==null?void 0:e.definitions)==null?void 0:k[0],H="name"in q?(Q=q.name)==null?void 0:Q.value:void 0;h||(h={fetch});try{const f=new AbortController,G=setTimeout(()=>{},A);try{const i=new Headers;let u={url:this.url,headers:i,method:"POST",body:JSON.stringify({query:x(e),variables:n}),signal:f.signal};for(const s of g||[])typeof s=="function"&&(u=s({load:h,doc:e,variables:n,cache:o,logger:a,request:u,controller:f}));const d=m&&o?o.name+JSON.stringify(n):null;if(d&&this.cacheMap.has(d))return{data:this.cacheMap.get(d),errors:void 0};const l=await h.fetch(u.url,{...u});if(l.ok){const s=await l.json();let p=(s==null?void 0:s.errors)||[];const v=s==null?void 0:s.data;if(p.length!==0){D||a.error(JSON.stringify({errorType:"api load error",status:l.status,url:this.url,errors:p,query:x(e),variables:n}));for(const C of E||[])typeof C=="function"&&(p=C({errors:p,doc:e,variables:n,load:h}))}else m&&d&&this.cacheMap.set(d,v);return{data:v,errors:p.length===0?void 0:{graphQLErrors:p}}}D||a.error(JSON.stringify({errorType:"bad response",url:this.url,status:l.status,DOC_NAME:H,response:l}));let O=l;for(const s of S||[])typeof s=="function"&&(O=await s({response:l,doc:e,variables:n,load:h,cache:o,logger:a}));return{data:null,errors:{networkError:O}}}catch(i){const u={errorType:"load error",url:this.url,DOC_NAME:H,error:i instanceof Error?i.toString():"unknown fetch error",errorMessage:i instanceof Error?i.message:"no error message",cause:i instanceof Error?i.cause:"no cause"};return a.error(JSON.stringify(u)),{data:null,errors:{networkError:new Response(JSON.stringify(u),{status:500,statusText:"Server error"})}}}finally{clearTimeout(G)}}catch(f){return a.error(f),{data:null,errors:{networkError:new Response(JSON.stringify(f),{status:500,statusText:"Server error"})}}}}async fetchGraphQL(r){const{data:e}=await this.query(r);return e}mutation(r,e){return this.fetchGraphQL({load:{fetch},doc:r,variables:e})}async mutate(r,e){return this.query({load:{fetch},doc:r,variables:e})}setUrl(r){this.url=r}getUrl(){return this.url}setDefaultHeaders(r){this.defaultHeaders={...r},this.requestInterceptors[0]=I(this.defaultHeaders)}updateDefaultHeaders(r){this.defaultHeaders={...this.defaultHeaders,...r},this.requestInterceptors[0]=I(this.defaultHeaders)}getDefaultHeaders(){return{...this.defaultHeaders}}setLogger(r){this.logger=r}getLogger(){return this.logger}addRequestInterceptor(r){this.requestInterceptors.push(r)}removeRequestInterceptor(r){const e=this.requestInterceptors.indexOf(r);return e!==-1?(this.requestInterceptors.splice(e,1),!0):!1}clearRequestInterceptors(){this.requestInterceptors.length=0,this.requestInterceptors.push(I(this.defaultHeaders),N)}getRequestInterceptors(){return[...this.requestInterceptors]}addGraphQLErrorInterceptor(r){this.graphQLErrorInterceptors.push(r)}removeGraphQLErrorInterceptor(r){const e=this.graphQLErrorInterceptors.indexOf(r);return e!==-1?(this.graphQLErrorInterceptors.splice(e,1),!0):!1}clearGraphQLErrorInterceptors(){this.graphQLErrorInterceptors.length=0}getGraphQLErrorInterceptors(){return[...this.graphQLErrorInterceptors]}addNetworkErrorInterceptor(r){this.networkErrorInterceptors.push(r)}removeNetworkErrorInterceptor(r){const e=this.networkErrorInterceptors.indexOf(r);return e!==-1?(this.networkErrorInterceptors.splice(e,1),!0):!1}clearNetworkErrorInterceptors(){this.networkErrorInterceptors.length=0}getNetworkErrorInterceptors(){return[...this.networkErrorInterceptors]}clearCache(){this.cacheMap.clear()}getCacheSize(){return this.cacheMap.size}removeCacheEntry(r){return this.cacheMap.delete(r)}}function P(t){function r({errors:e}){return e.forEach(n=>{t.next({type:(n==null?void 0:n.errorType)||"errorExchange",error:n})}),e}return r}let y=null;function J(t){return new b(t)}function V(t){y&&console.warn("Default GraphQL client already initialized"),y=J(t)}function w(){if(!y)throw new Error("Default GraphQL client is not initialized. Call initializeDefaultClient() first.");return y}function j(t){return w().query(t)}function B(t){return w().fetchGraphQL(t)}function K(t,r){return w().mutation(t,r)}function W(t,r){return w().mutate(t,r)}export{R as D,W as a,P as b,I as c,F as d,B as f,V as i,K as m,j as q,N as s};
